<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calverse - Choose Your Plan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Razorpay Checkout Script -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a;
            background-image: radial-gradient(circle at top right, rgba(251, 191, 36, 0.1), transparent 40%),
                              radial-gradient(circle at bottom left, rgba(245, 158, 11, 0.1), transparent 50%);
            color: #E5E7EB;
        }
        .glass-card {
            background: rgba(28, 28, 28, 0.6);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .animated-card {
            opacity: 0;
            transform: translateY(20px);
            animation: card-fade-in 0.6s ease forwards;
        }
        @keyframes card-fade-in { to { opacity: 1; transform: translateY(0); } }
        .glass-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }
        .pro-plan-highlight {
            box-shadow: 0 0 30px rgba(251, 191, 36, 0.3);
            border-color: rgba(251, 191, 36, 0.5);
        }
        .gradient-btn {
            background-image: linear-gradient(to right, #FBBF24, #F59E0B);
            transition: all 0.3s ease;
        }
        .gradient-btn:hover {
            box-shadow: 0 10px 20px rgba(251, 191, 36, 0.25);
            transform: scale(1.05);
        }
        .gradient-btn:disabled {
            background-image: linear-gradient(to right, #4b5563, #6b7280);
            cursor: not-allowed;
            opacity: 0.6;
        }
        .list-disc-amber li::marker { color: #FBBF24; }
        @keyframes pulse-badge {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 15px 5px rgba(251, 191, 36, 0); }
        }
        .pulse-badge { animation: pulse-badge 2.5s infinite cubic-bezier(0.4, 0, 0.6, 1); }
        .faq-item details > summary { list-style: none; }
        .faq-item details > summary::-webkit-details-marker { display: none; }
        .faq-item details[open] summary .arrow-icon { transform: rotate(180deg); }
        .arrow-icon { transition: transform 0.3s ease; }
        .success-checkmark { animation: scale-up 0.4s cubic-bezier(0.390, 0.575, 0.565, 1.000) both; }
        @keyframes scale-up { 0% { transform: scale(0.5); } 100% { transform: scale(1); } }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 sm:p-6 lg:p-8">

    <div id="app-container" class="w-full max-w-7xl mx-auto">
        
        <!-- View 1: Plan Selection -->
        <div id="plan-selection-view">
            <!-- Responsive Header Section -->
            <div class="text-center mb-12 md:mb-16">
                <h1 class="text-3xl sm:text-4xl lg:text-5xl font-extrabold text-white tracking-tight mb-3">Choose Your Plan</h1>
                <p class="text-base sm:text-lg text-gray-400 max-w-2xl mx-auto">Unlock full access to all premium features. The longer you commit, the more you save.</p>
            </div>

            <!-- Responsive Pricing Cards Grid -->
            <div id="pricing-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8 max-w-5xl mx-auto">
                <!-- Plan cards will be dynamically inserted here -->
            </div>

            <!-- Responsive FAQ Section -->
            <div class="max-w-4xl mx-auto mt-16 sm:mt-20">
                <h2 class="text-2xl sm:text-3xl font-bold text-center text-white mb-10">Frequently Asked Questions</h2>
                <div class="space-y-4">
                     <div class="faq-item glass-card animated-card rounded-xl p-5 sm:p-6" style="animation-delay: 0.4s;">
                         <details>
                             <summary class="flex justify-between items-center cursor-pointer font-semibold text-white">
                                 Can I cancel my subscription at any time?
                                 <svg class="w-6 h-6 text-gray-400 arrow-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                             </summary>
                             <p class="text-gray-400 mt-4">Yes, absolutely. You can cancel your subscription from your account dashboard at any time. You will retain access to premium features until the end of your current billing period.</p>
                         </details>
                     </div>
                     <div class="faq-item glass-card animated-card rounded-xl p-5 sm:p-6" style="animation-delay: 0.5s;">
                         <details>
                             <summary class="flex justify-between items-center cursor-pointer font-semibold text-white">
                                 What payment methods do you accept?
                                  <svg class="w-6 h-6 text-gray-400 arrow-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                             </summary>
                             <p class="text-gray-400 mt-4">We accept all major credit cards, UPI, and other popular digital wallets through our secure payment partner, Razorpay.</p>
                         </details>
                     </div>
                 </div>
            </div>
        </div>

        <!-- View 2: Billing Section -->
        <div id="billing-view" class="hidden">
            <div class="max-w-4xl mx-auto">
                <button id="back-to-plans-btn" class="flex items-center text-sm font-semibold text-gray-400 hover:text-amber-400 transition mb-6 sm:mb-8">
                    <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
                    Back to Plans
                </button>
                <!-- Responsive Billing Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-x-16">
                    <!-- Left Side: Order Summary -->
                    <div class="animated-card glass-card rounded-2xl p-6 sm:p-8">
                        <h2 class="text-xl sm:text-2xl font-bold text-white mb-6">Order Summary</h2>
                        <div id="order-summary-content"></div>
                        <div class="border-t border-gray-700 my-4"></div>
                        <div id="order-total-content"></div>

                        <!-- Coupon Code Section -->
                        <div id="coupon-section" class="mt-4">
                            <div class="flex space-x-2">
                                <input type="text" id="coupon-code-input" placeholder="Enter Coupon Code" class="flex-grow bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-400 text-white placeholder-gray-500">
                                <button id="apply-coupon-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold text-sm px-4 py-2 rounded-lg transition">Apply</button>
                            </div>
                            <p id="coupon-status" class="text-xs mt-2 h-4"></p> <!-- For showing status messages -->
                        </div>
                    </div>

                    <!-- Right Side: Payment Gateway -->
                    <div class="animated-card flex flex-col justify-center text-center" style="animation-delay: 0.1s;">
                        <h2 class="text-xl sm:text-2xl font-bold text-white mb-4">Complete Your Purchase</h2>
                        <p class="text-gray-400 mb-4 sm:mb-6">You will be redirected to Razorpay's secure payment gateway.</p>
                        <img src="https://razorpay.com/assets/razorpay-logo-white.svg" alt="Secure Payment with Razorpay" class="h-10 mx-auto my-4">
                        <div class="pt-6">
                            <button id="razorpay-btn" class="w-full gradient-btn text-gray-900 font-bold py-3 px-4 text-base sm:text-lg rounded-xl" disabled>
                                Pay Securely
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- View 3: Thank You & Redirect -->
        <div id="thank-you-view" class="hidden">
            <div class="max-w-2xl mx-auto text-center py-12 sm:py-16">
                <div class="flex justify-center mb-6">
                    <div class="success-checkmark bg-green-500 rounded-full p-4 inline-flex">
                        <svg class="w-12 h-12 sm:w-16 sm:h-16 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                </div>
                <h1 class="text-3xl sm:text-4xl lg:text-5xl font-extrabold text-white tracking-tight mb-4">Payment Successful!</h1>
                <p class="text-base sm:text-lg text-gray-300 mb-8">Thank you for upgrading! Your premium access has been activated. You can now explore all the advanced features.</p>
                <div class="flex items-center justify-center text-gray-400">
                    <svg class="animate-spin h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Redirecting to your dashboard...</span>
                </div>
            </div>
        </div>

    </div>

<script type="module">
    // Import Firebase services
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Your web app's Firebase configuration ---
    const firebaseConfig = {
      apiKey: "AIzaSyAS1fvvgtRXx9wLwmJec-2tkBX2PlnAuN0",
      authDomain: "calversev2.firebaseapp.com",
      databaseURL: "https://calversev2-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "calversev2",
      storageBucket: "calversev2.appspot.com",
      messagingSenderId: "794294005093",
      appId: "1:794294005093:web:6104521d5e4a2de812858c",
      measurementId: "G-PTT8TN4JG0"
    };

    // --- Initialize Firebase ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUser = null;

    // --- Main App Logic ---
    document.addEventListener('DOMContentLoaded', () => {
        // --- Element References ---
        const pricingGrid = document.getElementById('pricing-grid');
        const planSelectionView = document.getElementById('plan-selection-view');
        const billingView = document.getElementById('billing-view');
        const thankYouView = document.getElementById('thank-you-view');
        const backToPlansBtn = document.getElementById('back-to-plans-btn');
        const razorpayBtn = document.getElementById('razorpay-btn');
        const applyCouponBtn = document.getElementById('apply-coupon-btn');
        const couponCodeInput = document.getElementById('coupon-code-input');
        const couponStatus = document.getElementById('coupon-status');
        
        // --- State and Constants ---
        const GST_RATE = 0.18;
        let currentPurchase = null;
        let appliedCoupon = null;

        // --- Handle Firebase Authentication ---
        onAuthStateChanged(auth, (user) => {
            const allButtons = document.querySelectorAll('button');
            if (user) {
                currentUser = user;
                console.log("User is authenticated:", currentUser.uid);
                allButtons.forEach(btn => btn.disabled = false);
            } else {
                console.log("User not signed in. Attempting anonymous sign-in.");
                allButtons.forEach(btn => btn.disabled = true);
                signInAnonymously(auth).catch(error => {
                    console.error("Anonymous sign-in failed:", error);
                });
            }
        });
        
        const premiumFeatures = [
            'Access to all dashboard analytics', 'Advanced recipe generator', 'Personalized cravings solver',
            'Save unlimited daily logs', 'View complete history', 'Advanced nutrition breakdown', 'Priority customer support'
        ];

        // --- Plan Definitions ---
        const plans = [
            { name: 'Starter', priceValue: 99, price: '₹99', period: '/ 1 Month', highlight: false, durationInDays: 30 },
            { name: 'Growth', priceValue: 269, price: '₹269', period: '/ 3 Months', highlight: true, durationInDays: 90 },
            { name: 'Pro', priceValue: 499, price: '₹499', period: '/ 6 Months', highlight: false, durationInDays: 180 }
        ];

        // --- Renders all pricing plan cards ---
        function renderPlans() {
            pricingGrid.innerHTML = '';
            plans.forEach((plan, index) => {
                const card = document.createElement('div');
                card.className = `glass-card animated-card rounded-3xl p-6 sm:p-8 flex flex-col relative ${plan.highlight ? 'pro-plan-highlight' : ''}`;
                card.style.animationDelay = `${index * 0.1}s`;
                card.innerHTML = `
                    ${plan.highlight ? `<div class="absolute top-0 -translate-y-1/2 w-full flex justify-center"><span class="pulse-badge bg-amber-400 text-gray-900 text-xs font-bold px-4 py-1 rounded-full uppercase">Most Popular</span></div>` : ''}
                    <div class="flex-grow">
                        <h3 class="text-xl sm:text-2xl font-bold text-white">${plan.name} Plan</h3>
                        <p class="mt-2"><span class="text-3xl sm:text-4xl font-extrabold text-white">${plan.price}</span><span class="text-gray-400 font-medium">${plan.period}</span></p>
                        <p class="text-xs text-gray-500 mt-1">(+ 18% GST)</p>
                        <h4 class="font-semibold text-white mt-6 mb-2">All Premium Features Included:</h4>
                        <ul class="list-disc list-disc-amber list-inside text-gray-300 mt-4 space-y-2 text-sm">${premiumFeatures.map(f => `<li>${f}</li>`).join('')}</ul>
                    </div>
                    <div class="mt-8">
                        <button data-plan-name="${plan.name}" class="choose-btn w-full gradient-btn text-gray-900 font-bold py-3 px-4 rounded-xl" disabled>Choose ${plan.name}</button>
                    </div>`;
                pricingGrid.appendChild(card);
            });
        }

        // --- Recalculates and displays the order summary ---
        function renderOrderSummary() {
            const plan = plans.find(p => p.name === currentPurchase.planName);
            if (!plan) return;

            const subtotal = plan.priceValue;
            let discountAmount = 0;
            
            if (appliedCoupon) {
                discountAmount = subtotal * (appliedCoupon.discountPercentage / 100);
            }

            const discountedSubtotal = subtotal - discountAmount;
            const gstAmount = discountedSubtotal * GST_RATE;
            const total = discountedSubtotal + gstAmount;

            currentPurchase.amount = Math.round(total * 100);
            currentPurchase.totalString = total.toFixed(2);
            currentPurchase.appliedCoupon = appliedCoupon ? appliedCoupon.code : 'None';

            document.getElementById('order-summary-content').innerHTML = `
                <div class="flex justify-between items-center text-gray-300 mb-3"><span>${plan.name} Plan</span><span class="font-medium text-white">₹${subtotal.toFixed(2)}</span></div>
                ${appliedCoupon ? `<div class="flex justify-between items-center text-green-400 mb-3"><span>Discount (${appliedCoupon.code})</span><span class="font-medium">- ₹${discountAmount.toFixed(2)}</span></div>` : ''}
                <div class="flex justify-between items-center text-gray-300"><span>GST (18%)</span><span class="font-medium text-white">₹${gstAmount.toFixed(2)}</span></div>`;
            
            document.getElementById('order-total-content').innerHTML = `
                <div class="flex justify-between items-center font-bold text-white text-lg"><span>Total Payable</span><span>₹${total.toFixed(2)}</span></div>`;
            
            razorpayBtn.innerHTML = `Pay ₹${currentPurchase.totalString} Securely`;
        }

        // --- Switches to the billing view for a selected plan ---
        function showBillingView(planName) {
            const plan = plans.find(p => p.name === planName);
            if (!plan) return;

            currentPurchase = {
                planName: plan.name,
                description: `Payment for Calverse ${plan.name} Plan`,
            };
            
            // Reset coupon state
            appliedCoupon = null;
            couponCodeInput.value = '';
            couponStatus.textContent = '';
            couponStatus.className = 'text-xs mt-2 h-4';

            renderOrderSummary();
            
            planSelectionView.classList.add('hidden');
            billingView.classList.remove('hidden');
        }

        // --- Switches back to the main plan selection view ---
        function showPlanSelectionView() {
            billingView.classList.add('hidden');
            thankYouView.classList.add('hidden');
            planSelectionView.classList.remove('hidden');
            currentPurchase = null;
        }

        // --- Updates user data in Firestore after successful payment ---
        async function updateUserPremiumStatus(paymentId) {
            if (!currentUser || !currentPurchase) {
                console.error("Critical Error: User or Purchase details missing.");
                alert("An error occurred. Please try again.");
                return;
            }

            razorpayBtn.disabled = true;
            razorpayBtn.innerHTML = 'Finalizing...';

            try {
                const purchasedPlan = plans.find(p => p.name === currentPurchase.planName);
                if (!purchasedPlan) throw new Error("Could not find the purchased plan details.");

                const currentDate = new Date();
                const expirationDate = new Date(currentDate);
                expirationDate.setDate(currentDate.getDate() + purchasedPlan.durationInDays);

                const userDocRef = doc(db, "users", currentUser.uid);
                const purchaseDocRef = doc(db, "users", currentUser.uid, "purchases", paymentId);

                await setDoc(purchaseDocRef, {
                    planName: currentPurchase.planName,
                    amountPaid: currentPurchase.amount / 100,
                    currency: "INR",
                    purchaseDate: serverTimestamp(),
                    razorpayPaymentId: paymentId,
                    appliedCoupon: currentPurchase.appliedCoupon,
                });

                await setDoc(userDocRef, {
                    premium: "yes",
                    premiumPlan: currentPurchase.planName,
                    lastPurchaseDate: serverTimestamp(),
                    premiumExpirationDate: expirationDate
                }, { merge: true });

                console.log(`Successfully updated user ${currentUser.uid} to premium. Expires on: ${expirationDate.toISOString()}`);
                
                billingView.classList.add('hidden');
                thankYouView.classList.remove('hidden');

                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 4000);

            } catch (error) {
                console.error("Error updating user status in Firestore:", error);
                razorpayBtn.innerHTML = 'Payment Failed. Contact Support.';
                alert('There was an issue updating your account. Please contact support.');
            }
        }

        // --- Event Listener for applying a coupon ---
        applyCouponBtn.addEventListener('click', async () => {
            const code = couponCodeInput.value.trim().toUpperCase();
            if (!code) {
                couponStatus.textContent = 'Please enter a code.';
                couponStatus.className = 'text-xs mt-2 h-4 text-red-400';
                return;
            }

            applyCouponBtn.disabled = true;
            couponStatus.textContent = 'Validating...';
            couponStatus.className = 'text-xs mt-2 h-4 text-amber-400';

            try {
                const couponDocRef = doc(db, "coupons", code);
                const couponDoc = await getDoc(couponDocRef);

                if (couponDoc.exists()) {
                    const couponData = couponDoc.data();
                    const currentPlanName = currentPurchase.planName;
                    
                    // NEW: Check if coupon is valid for the current plan
                    const isPlanSpecific = Array.isArray(couponData.applicablePlans) && couponData.applicablePlans.length > 0;
                    
                    if (isPlanSpecific && !couponData.applicablePlans.includes(currentPlanName)) {
                        // Coupon is not valid for this specific plan
                        appliedCoupon = null;
                        couponStatus.textContent = 'This coupon is not valid for the selected plan.';
                        couponStatus.className = 'text-xs mt-2 h-4 text-red-400';
                    } else {
                        // Coupon is valid (either general or for this specific plan)
                        appliedCoupon = couponData;
                        couponStatus.textContent = `Success! ${appliedCoupon.discountPercentage}% discount applied.`;
                        couponStatus.className = 'text-xs mt-2 h-4 text-green-400';
                    }
                } else {
                    appliedCoupon = null;
                    couponStatus.textContent = 'Invalid or expired coupon code.';
                    couponStatus.className = 'text-xs mt-2 h-4 text-red-400';
                }
            } catch (error) {
                console.error("Error validating coupon:", error);
                appliedCoupon = null;
                couponStatus.textContent = 'Could not validate coupon.';
                couponStatus.className = 'text-xs mt-2 h-4 text-red-400';
            } finally {
                renderOrderSummary(); // Recalculate total regardless of outcome
                applyCouponBtn.disabled = false;
            }
        });

        // --- General Event Listeners ---
        pricingGrid.addEventListener('click', (e) => {
            if (e.target.classList.contains('choose-btn')) {
                showBillingView(e.target.dataset.planName);
            }
        });

        backToPlansBtn.addEventListener('click', showPlanSelectionView);

        razorpayBtn.addEventListener('click', (e) => {
            if (!currentPurchase || !currentUser) {
                 alert("Please wait for user authentication to complete.");
                 return;
            };

            const payButton = e.target;
            payButton.disabled = true;
            payButton.innerHTML = `Redirecting...`;

            const options = {
                "key": "rzp_test_siRSG8YjKS1zhm", // Your Razorpay Key ID
                "amount": currentPurchase.amount,
                "currency": "INR",
                "name": "Calverse",
                "description": currentPurchase.description,
                "image": "https://placehold.co/128x128/fbbf24/0a0a0a?text=C",
                "handler": (response) => updateUserPremiumStatus(response.razorpay_payment_id),
                "prefill": {
                    "name": currentUser.displayName || "Calverse User",
                    "email": currentUser.email || "",
                    "contact": currentUser.phoneNumber || ""
                },
                "notes": {
                    "plan": currentPurchase.planName,
                    "firebase_uid": currentUser.uid,
                    "coupon_used": currentPurchase.appliedCoupon,
                },
                "theme": { "color": "#FBBF24" },
                "modal": {
                    "ondismiss": () => {
                        payButton.disabled = false;
                        renderOrderSummary(); // Re-render to show correct price on button
                    }
                }
            };
            
            const rzp1 = new Razorpay(options);
            rzp1.on('payment.failed', (response) => {
                console.error("Payment Failed:", response.error.description);
                payButton.disabled = false;
                renderOrderSummary();
                alert(`Payment Failed: ${response.error.description}`);
            });
            rzp1.open();
        });

        // --- Initial Render ---
        renderPlans();
    });
</script>

</body>
</html>
